@using System.ComponentModel
@using GUI.Coordinators
@using GUI.Entites

<MudTextField T="string" Variant="Variant.Outlined" Label="Title of your story" Class="mb-4"/>

<MudContainer Class="pa-0">
    @foreach (TextComponent component in _textComponents)
    {
        <MudContainer Class="pa-0 d-flex flex-row flex-grow-1">
            <MudContainer Class="pa-0 d-flex flex-column justify-content-center" Style="width: fit-content">
                <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.ArrowUpward" Disabled="@IsFirstItem(component)" OnClick="() => MoveItemUp(component)" Color="Color.Primary"/>
                <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.ArrowDownward" Disabled="@IsLastItem(component)" OnClick="() => MoveItemDown(component)" Color="Color.Primary"/>
            </MudContainer>
            <MudContainer Class="pa-0 d-flex flex-grow-1 align-content-center">
                @switch (component.Type)
                {
                    case TextComponentType.TextField:
                        <MudTextField @bind-Value="component.Content" Variant="Variant.Filled" AutoGrow ShrinkLabel Label="Write your story here"
                                      Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Delete" OnAdornmentClick="() => OnDeleteTextField(component)"/>
                        break;
                    case TextComponentType.TextOption:
                        <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="() => OnOptionButtonClicked(component)">
                            Option
                        </MudButton>
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" OnClick="() => OnDeleteTextField(component)">Remove</MudIconButton>
                        break;
                    default:
                        throw new ArgumentOutOfRangeException();
                }
            </MudContainer>
        </MudContainer>
        <br/>
    }
</MudContainer>

<MudDivider Style="height: 2px" Class="ma-4"/>

<MudContainer>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="() => OnAddButtonClick(TextComponentType.TextField)">Add Text</MudButton>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="() => OnAddButtonClick(TextComponentType.TextOption)">Add Option</MudButton>
</MudContainer>

@code {
    [Inject]
    private StoryEditCoordinator? StoryEditCoordinator { get; set; }
    private List<TextComponent> _textComponents = new();

    private bool IsFirstItem(TextComponent item) => _textComponents.IndexOf(item) == 0;
    private bool IsLastItem(TextComponent item) => _textComponents.IndexOf(item) == _textComponents.Count - 1;

    private void OnAddButtonClick(TextComponentType componentType)
    {
        var id = new TextComponent
        {
            Type = componentType
        };
        _textComponents.Add(id);
    }

    private void OnDeleteTextField(TextComponent id)
    {
        _textComponents.Remove(id);
    }

    private void OnOptionButtonClicked(TextComponent component)
    {
        if (StoryEditCoordinator != null) StoryEditCoordinator.SelectedOption = component.Guid;
    }

    private void MoveItemUp(TextComponent item)
    {
        var index = _textComponents.IndexOf(item);
        if (index > 0)
        {
            (_textComponents[index - 1], _textComponents[index]) = (_textComponents[index], _textComponents[index - 1]);
        }
    }

    private void MoveItemDown(TextComponent item)
    {
        var index = _textComponents.IndexOf(item);
        if (index < _textComponents.Count - 1)
        {
            (_textComponents[index + 1], _textComponents[index]) = (_textComponents[index], _textComponents[index + 1]);
        }
    }
}